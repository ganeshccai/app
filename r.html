<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>Chat</title>
    <style>
      :root{
        --bg: #f6f7f9;
        --user-bubble: #dff6f0;
        --agent-bubble: #ffffff;
        --muted: #666;
      }
      html,body{height:100%;margin:0;padding:0;font-family:Segoe UI, system-ui, -apple-system, sans-serif;background:var(--bg)}
      header{background:#ffffff;padding:12px 16px;box-shadow:0 1px 2px rgba(0,0,0,0.06);font-weight:600}
      #chat-container{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;height:calc(100vh - 160px)}
      .message{max-width:78%;padding:10px 12px;border-radius:12px;position:relative;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
      .user-msg{align-self:flex-end;background:var(--user-bubble)}
      .agent-msg{align-self:flex-start;background:var(--agent-bubble)}
      .timestamp{font-size:11px;color:var(--muted);margin-top:6px;display:inline-block;padding:2px 6px;border-radius:6px}
      .timestamp{cursor:pointer}
      .options{position:absolute;right:-8px;top:50%;transform:translateY(-50%);display:none;flex-direction:column;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);padding:6px;gap:6px;z-index:30}
      .options.show{display:flex}
      .option-btn{background:none;border:none;padding:8px;border-radius:6px;cursor:pointer;font-size:16px}
      .reactions{display:flex;gap:6px;margin-top:6px}
      .reaction{background:#fff;border:1px solid #eee;padding:4px 8px;border-radius:12px;font-size:13px;cursor:pointer}
      #input-container{display:flex;gap:8px;padding:12px;background:#fff;align-items:flex-end}
      #msg{flex:1;padding:8px 10px;border-radius:8px;border:1px solid #eee;min-height:36px;resize:none}
      #emoji-picker{position:absolute;bottom:64px;right:16px;background:#fff;border:1px solid #eee;padding:8px;border-radius:8px;display:none}
      #emoji-picker.show{display:block}
      .emoji-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
      .emoji-btn{background:none;border:none;font-size:18px;cursor:pointer}
      .upload-progress{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.75);color:#fff;padding:12px;border-radius:8px}
      #login-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
      #login-box{background:#fff;padding:20px;border-radius:8px;display:flex;flex-direction:column;gap:8px;min-width:280px}
      #reply-indicator{padding:8px;background:#f0f0f0;border-radius:8px;margin-bottom:8px}
    </style>
  </head>
  <body data-chat-id="1234">
    <div id="login-overlay">
      <div id="login-box">
        <input id="pwd" type="password" placeholder="Enter password" />
        <button id="login-btn">Login</button>
        <div id="login-msg" style="color:red"></div>
      </div>
    </div>

    <header>Chat <span id="agent-status">üî¥</span></header>
    <div id="chat-container"></div>

    <div id="input-container">
      <textarea id="msg" rows="1" placeholder="Type a message..."></textarea>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button id="emoji-btn">üòä</button>
        <button id="upload-btn">üñºÔ∏è</button>
        <button id="clear-btn">‚ùå</button>
      </div>
      <button id="send-btn">‚û§</button>
      <div id="emoji-picker">
        <div class="emoji-grid">
          <button class="emoji-btn" data-emoji="üòä">üòä</button>
          <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
          <button class="emoji-btn" data-emoji="üòç">üòç</button>
          <button class="emoji-btn" data-emoji="üëç">üëç</button>
          <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
          <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
        </div>
      </div>
      <input id="file-input" type="file" accept="image/*" style="display:none" />
    </div>

    <script>
      const BACKEND_URL = "https://app-788207962975.us-central1.run.app";
      const chatId = document.body.dataset.chatId || "1234";
      let isLoggedIn = false;
      let sessionToken = null;
      let replyingTo = null;

      const msgInput = document.getElementById('msg');
      const sendBtn = document.getElementById('send-btn');
      const clearBtn = document.getElementById('clear-btn');
      const chatContainer = document.getElementById('chat-container');
      const agentStatus = document.getElementById('agent-status');
      const emojiBtn = document.getElementById('emoji-btn');
      const emojiPicker = document.getElementById('emoji-picker');
      const uploadBtn = document.getElementById('upload-btn');
      const fileInput = document.getElementById('file-input');

      document.getElementById('login-btn').addEventListener('click', checkPwd);

      async function checkPwd(){
        const pwd = document.getElementById('pwd').value;
        if(!pwd){document.getElementById('login-msg').textContent='Enter password';return}
        try{
          const res = await fetch(`${BACKEND_URL}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:chatId,password:pwd,sender:'user'})});
          const data = await res.json();
          if(data.success){sessionToken = data.session_token; isLoggedIn = true; document.getElementById('login-overlay').style.display='none'; startPolling()} else {document.getElementById('login-msg').textContent = data.error||'Login failed'}
        }catch(e){console.error(e);document.getElementById('login-msg').textContent='Connection error'}
      }

      function startPolling(){loadMessages(); checkStatus(); markOnline(); setInterval(()=>{ if(isLoggedIn) loadMessages(); },1000); setInterval(()=>{ if(isLoggedIn) markOnline(); },2000)}

      async function sendMessage(){
        const text = msgInput.value.trim();
        if(!text || !isLoggedIn || !sessionToken) return;
        try{
          const body = { chat_id: chatId, sender: 'user', text };
          if(replyingTo){ body.reply_to = replyingTo; replyingTo = null; const ind = document.getElementById('reply-indicator'); if(ind) ind.remove(); }
          const r = await fetch(`${BACKEND_URL}/send`,{ method:'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}`}, body: JSON.stringify(body) });
          if(!r.ok){ if(r.status===403){ isLoggedIn=false; sessionToken=null; document.getElementById('login-overlay').style.display='flex'; return } throw new Error('send failed') }
          msgInput.value=''; loadMessages();
        }catch(e){ console.error(e); alert('Failed to send message') }
      }

      async function loadMessages(){
        if(!isLoggedIn || !sessionToken) return;
        try{
          const isTabActive = document.visibilityState === 'visible';
          const res = await fetch(`${BACKEND_URL}/messages/${chatId}?viewer=user&active=${isTabActive}`,{ headers: {'Authorization':`Bearer ${sessionToken}`} });
          if(!res.ok){ if(res.status===403){ isLoggedIn=false; sessionToken=null; document.getElementById('login-overlay').style.display='flex'; return } throw new Error('load failed') }
          const messages = await res.json();
          chatContainer.innerHTML = '';
          messages.forEach(m => {
            const msgDiv = document.createElement('div'); msgDiv.className = `message ${m.sender==='user'?'user-msg':'agent-msg'}`;

            if(m.reply_to){ const replyMsg = messages.find(x=>x.id===m.reply_to); if(replyMsg){ const r = document.createElement('div'); r.className='reply-to'; r.textContent = replyMsg.text || 'Image'; r.style.fontSize='13px'; r.style.opacity='0.9'; r.style.marginBottom='6px'; msgDiv.appendChild(r) } }

            if(m.type==='image'){ const img = document.createElement('img'); img.src = m.url; img.style.maxWidth='200px'; img.style.borderRadius='8px'; msgDiv.appendChild(img) } else { const textDiv = document.createElement('div'); textDiv.className='message-text'; textDiv.textContent = m.text; msgDiv.appendChild(textDiv) }

            const timestamp = document.createElement('div'); timestamp.className='timestamp'; timestamp.textContent = new Date(m.timestamp*1000).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});

            const options = document.createElement('div'); options.className='options';

            // Timestamp click toggles the options menu (only timestamp opens)
            timestamp.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.options.show').forEach(o=>{ if(o!==options) o.classList.remove('show') }); options.classList.toggle('show'); });

            // Close open options when clicking anywhere else
            document.addEventListener('click', (e)=>{ if(!e.target.closest('.timestamp')) document.querySelectorAll('.options.show').forEach(o=>o.classList.remove('show')) });

            // Option buttons order: Edit, Delete, Emoji, Reply
            if(m.sender==='user'){
              const editBtn = document.createElement('button'); editBtn.className='option-btn'; editBtn.title='Edit'; editBtn.textContent='‚úèÔ∏è';
              editBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); const newText = prompt('Edit message:', m.text); if(newText!==null && newText.trim()!=='' && newText !== m.text){ try{ const r = await fetch(`${BACKEND_URL}/edit_message`,{ method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}` }, body: JSON.stringify({ chat_id: chatId, message_id: m.id, text: newText, user_id: 'user' }) }); if(r.ok) loadMessages(); else throw new Error('edit failed') }catch(err){ console.error(err); alert('Edit failed') } } options.classList.remove('show'); });
              options.appendChild(editBtn);

              const delBtn = document.createElement('button'); delBtn.className='option-btn'; delBtn.title='Delete'; delBtn.textContent='üóëÔ∏è';
              delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(confirm('Delete this message?')){ deleteMessage(m.id); options.classList.remove('show') } });
              options.appendChild(delBtn);
            }

            const emojiBtnQuick = document.createElement('button'); emojiBtnQuick.className='option-btn'; emojiBtnQuick.title='Emoji'; emojiBtnQuick.textContent='üòä';
            emojiBtnQuick.addEventListener('click',(ev)=>{ ev.stopPropagation(); const picker = emojiPicker.cloneNode(true); picker.id=''; picker.style.display='block'; picker.style.position='absolute'; picker.style.bottom='100%'; picker.style.right='0'; options.appendChild(picker); picker.querySelectorAll('.emoji-btn').forEach(b=>{ b.addEventListener('click',(e)=>{ e.stopPropagation(); addReaction(m.id, b.dataset.emoji); picker.remove(); options.classList.remove('show'); }) }); document.addEventListener('click', ()=>{ if(picker && picker.remove) picker.remove() }, { once:true }) });
            options.appendChild(emojiBtnQuick);

            const replyBtn = document.createElement('button'); replyBtn.className='option-btn'; replyBtn.title='Reply'; replyBtn.textContent='‚Ü©Ô∏è';
            replyBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); replyingTo = m.id; msgInput.focus(); const existing = document.getElementById('reply-indicator'); if(existing) existing.remove(); const replyIndicator = document.createElement('div'); replyIndicator.id='reply-indicator'; replyIndicator.textContent = `Replying to: ${m.text || 'Image'}`; const cancelBtn = document.createElement('button'); cancelBtn.textContent='‚ùå'; cancelBtn.style.marginLeft='8px'; cancelBtn.addEventListener('click', ()=>{ replyingTo = null; replyIndicator.remove() }); replyIndicator.appendChild(cancelBtn); document.getElementById('input-container').insertBefore(replyIndicator, msgInput); options.classList.remove('show'); });
            options.appendChild(replyBtn);

            msgDiv.appendChild(timestamp);
            msgDiv.appendChild(options);

            if(m.reactions && Object.keys(m.reactions).length>0){ const reactionsDiv = document.createElement('div'); reactionsDiv.className='reactions'; Object.entries(m.reactions).forEach(([emoji,users])=>{ const reaction = document.createElement('div'); reaction.className='reaction'; reaction.textContent = `${emoji} ${users.length}`; reaction.addEventListener('click', ()=>addReaction(m.id, emoji)); reactionsDiv.appendChild(reaction) }); msgDiv.appendChild(reactionsDiv) }

            chatContainer.appendChild(msgDiv);
          });
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }catch(err){ console.error('load messages error', err) }
      }

      async function addReaction(messageId, emoji){ if(!isLoggedIn || !sessionToken) return; try{ const r = await fetch(`${BACKEND_URL}/react`,{ method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}` }, body: JSON.stringify({ chat_id: chatId, message_id: messageId, reaction: emoji, user_id: 'user' }) }); if(!r.ok) throw new Error('react failed'); loadMessages(); }catch(e){ console.error(e) } }

      async function deleteMessage(messageId){ if(!isLoggedIn || !sessionToken) return; try{ const r = await fetch(`${BACKEND_URL}/delete_message`,{ method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}` }, body: JSON.stringify({ chat_id: chatId, message_id: messageId, user_id: 'user' }) }); if(!r.ok) throw new Error('delete failed'); loadMessages(); }catch(e){ console.error(e); alert('Failed to delete message') } }

      async function checkStatus(){ if(!isLoggedIn) return; try{ const r = await fetch(`${BACKEND_URL}/is_online/${chatId}`); const data = await r.json(); agentStatus.textContent = data.agent_online ? 'üü¢' : 'üî¥'; }catch(e){ console.error(e) } }
      async function markOnline(){ if(!isLoggedIn || !sessionToken) return; try{ await fetch(`${BACKEND_URL}/mark_online`,{ method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}` }, body: JSON.stringify({ chat_id: chatId, sender: 'user' }) }) }catch(e){ console.error(e) } }

      uploadBtn.addEventListener('click', ()=>{ if(!isLoggedIn || !sessionToken){ alert('Please log in first'); return } fileInput.click() });
      fileInput.addEventListener('change', async ()=>{ const file = fileInput.files[0]; if(!file) return; if(file.size > 5*1024*1024){ alert('File too large. Max 5MB'); fileInput.value = ''; return } if(!file.type.startsWith('image/')){ alert('Select an image'); fileInput.value=''; return } try{ const progress = document.createElement('div'); progress.className='upload-progress'; progress.textContent='Uploading...'; document.body.appendChild(progress); const fd = new FormData(); fd.append('file', file); fd.append('chat_id', chatId); fd.append('sender', 'user'); const up = await fetch(`${BACKEND_URL}/upload`,{ method:'POST', headers:{ 'Authorization':`Bearer ${sessionToken}` }, body: fd }); if(!up.ok) throw new Error('upload failed'); const { success, url, error } = await up.json(); if(!success) throw new Error(error||'upload failed'); await fetch(`${BACKEND_URL}/send`,{ method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionToken}` }, body: JSON.stringify({ chat_id: chatId, sender: 'user', type: 'image', url }) }); progress.remove(); fileInput.value=''; loadMessages(); }catch(e){ console.error(e); alert('Upload failed'); const p = document.querySelector('.upload-progress'); if(p) p.remove() } });

      emojiBtn.addEventListener('click', (e)=>{ e.stopPropagation(); emojiPicker.classList.toggle('show') });
      document.addEventListener('click', (e)=>{ if(!emojiPicker.contains(e.target) && e.target !== emojiBtn) emojiPicker.classList.remove('show') });
      document.querySelectorAll('.emoji-btn').forEach(b=> b.addEventListener('click', ()=>{ const emoji = b.dataset.emoji; const pos = msgInput.selectionStart; msgInput.value = msgInput.value.slice(0,pos) + emoji + msgInput.value.slice(pos); msgInput.focus(); msgInput.selectionStart = msgInput.selectionEnd = pos + emoji.length; emojiPicker.classList.remove('show') }));

      sendBtn.addEventListener('click', sendMessage);
      clearBtn.addEventListener('click', ()=>{ if(confirm('Clear all messages?')) chatContainer.innerHTML = '' });
      msgInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage() } });

      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && isLoggedIn){ markOnline(); loadMessages() } });
      window.addEventListener('beforeunload', ()=>{ if(isLoggedIn && sessionToken){ const data = JSON.stringify({ chat_id: chatId, sender: 'user' }); navigator.sendBeacon(`${BACKEND_URL}/logout_user`, data) } });

      document.getElementById('pwd').addEventListener('keypress', (e)=>{ if(e.key==='Enter') checkPwd() });
    </script>
  </body>
</html>
